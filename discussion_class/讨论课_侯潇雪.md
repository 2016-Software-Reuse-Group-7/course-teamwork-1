#软件复用讨论课01                     

###解决方案      
###姓名：                  1352855  侯潇雪                           


#####问题：用户登录后始终在线，考虑低带宽/不稳定网络
#####解决：
我们组的项目引入了websocket第三方库。
Websocket协议是为了解决web即时应用中服务器与客户端浏览器全双工通信的问题而设计的，是完全意义上的Web应用端的双向通信技术，可以取代之前使用半双工HTTP协议而模拟全双工通信，同时克服了带宽和访问速度等的诸多问题。
协议包含两个部分，第一个是“握手”，第二个是数据传输。以下便从这两个方面，针对连接的建立和断开，心跳机制的引入，消息的不重复不遗漏和消息压缩四个方面进行阐述，提出了解决方案。

#####1.连接的建立和断开

三次握手确认建立一个连接:
    第一次握手：主机A发送位码为syn＝1,随机产生seqnumber=1234567的数据包到服务器，主机B由SYN=1知道，A要求建立联机；
    第二次握手：主机B收到请求后要确认联机信息，向A发送acknumber=(主机A的seq+1),syn=1,ack=1,随机产生seq=7654321的包
    第三次握手：主机A收到后检查acknumber是否正确，即第一次发送的seqnumber+1,以及位码ack是否为1，若正确，主机A会再发送acknumber=(主机B的seq+1),ack=1，主机B收到后确认seq值与ack=1则连接建立成功。
    完成三次握手，主机A与主机B开始传送数据。


采用四次分手断开一条连接：
由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。这个原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。
客户端A发送一个FIN，用来关闭客户A到服务器B的数据传送（报文段4）。
服务器B收到这个FIN，它发回一个ACK，确认序号为收到的序号加1（报文段5）。和SYN一样，一个FIN将占用一个序号。
服务器B关闭与客户端A的连接，发送一个FIN给客户端A（报文段6）。
客户端A发回ACK报文确认，并将确认序号设置为收到序号加1（报文段7）。



#####2.长时间心跳机制（检测用户是否掉线）：
在低带宽/不稳定网络下，用户容易出现掉线的现象，即客户端和服务端莫名其妙的断开连接，并且这种断开是SOCKET收不到提示消息的那种，只有循环的心跳检测才能发现。   
每隔固定时间发一次包，以此来告诉服务器，这个客户端还连接着，发送的这个包很小，或者是只包含包头的一个空包，即心跳包（用于长连接的保活和短线处理：包括数据清洗，重新连接）。
    
心跳检测步骤：
1客户端每隔一个时间间隔发生一个探测包给服务器；
2客户端发包时启动一个超时定时器；
3服务器端接收到检测包，应该回应一个包；
4如果客户机收到服务器的应答包，则说明服务器正常，删除超时定时器；
5如果客户端的超时定时器超时，依然没有收到应答包，则说明服务器挂了；


#####3.消息不遗漏及不重复
在发送消息时使用滑动窗口协议及拥塞控制。
只有在接收窗口向前滑动时（与此同时也发送了确认），发送窗口才有可能向前滑动。
收发两端的窗口按照以上规律不断地向前滑动，因此这种协议又称为滑动窗口协议。
当发送窗口和接收窗口的大小均大于1时，就是选择重发协议。协议中规定，对于窗口内未经确认的分组需要重传。这种分组的数量最多可以等于发送窗口的大小，即滑动窗口的大小n减去1（因为发送窗口不可能大于（n-1），起码接收窗口要大于等于1）。
     这样，当消息在传递过程中发生丢失或者延迟时还可以保证消息的不遗漏和不重复。

#####4.消息压缩
在有些情况下比如网络环境不好或者对象比较大的情况下需要把数据对象进行压缩然后在传输，此时就需要压缩这些对象流，此时就可以 GZIPInputStream和GZIPOutputStream来处理一下socket的InputStream和OutputStream。
在Server端使用，socket的InputStream首先被包装成GZIPInputStream，然后又被包装成 ObjectInputStream，而socket的OutputStream首先被包装成GZIPOutputStream，然后又被包装成 ObjectOutputStream。
Client也和Server端类似，同样要不socket的XXXStream包装成GZIPXXXStream，然后再包装成ObjectXXXStream。
（引用自http://blog.csdn.net/kongxx/article/details/7259834）


