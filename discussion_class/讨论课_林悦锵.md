##讨论课－复用解决方案

###讨论内容
用户登录后始终在线，考虑低带宽、不稳定网络：
- 长连接心跳机制
- 消息不遗漏
- 消息不重复
- 消息压缩

###资料查找与整理
**什么是长连接心跳机制**
维护任何一个长连接都需要心跳机制，客户端发送一个心跳给服务器，服务器给客户端一个心跳应答，这样就形成客户端服务器的一次完整的握手，这个握手是让双方都知道他们之间的连接是没有断开。
如果超过一个时间的阈值，客户端没有收到服务器的应答，或者服务器没有收到客户端的心跳，那么对服务器来说只要断开这个连接即可，对客户端来说，则需要断开与服务器的连接然后再重新建立一个新的连接。

**为什么会有消息遗漏、重复**
考虑到用户可能处于低带宽、不稳定的网络下，所以发送的消息会有丢失的情况。客户端发送的消息丢失造成消息遗漏，服务端发送的回复丢失或者超时造成客户端消息重发，以致服务端收到的消息重复。

**为什么需要消息压缩**
对消息进行压缩再发送能有效减轻消息的有效负载。
对于WebSocket协议，已经通过了“压缩扩展”的草案，具体地说，它允许客户端和服务端协商压缩算法及其参数，然后选择性地应用到WebSocket的消息上来减轻数据的有效载荷。


###解决方案
**长连接心跳机制**
我们项目中使用的是WebSocket协议。协议允许两个相连的端在一个单一的TCP连接上进行双全工消息通讯，建立连接以后，连接将一直保持活跃直到一方终止连接，也可能是一些外部因素，比如物理网络出现问题。
但是为了保证每个连接都是有用的，可以设置一个定时器，从客户端和服务端最后一次传递消息开始计算，定时结束时从服务端发送个消息给客户端，如果没能在一定时间内得到应答就断开连接。
另外，因为WebSocket旨在通过仅在建立连接时发送上下文信息，在建立连接后允许连接的两端在携带着极少的标示信息的上下文信息的情况下发送信息，以此来显著增加网络效率，这样建立心跳机制并不会浪费太多资源。

**避免消息遗漏、重复**
当客户端发送消息给服务端时，客户端设置一个定时器，一定时间内如果没有收到服务端发回的确认消息，就重新发送消息，避免消息的遗漏。
客户端在发出的消息里附上一个递增的标示，服务端维护一张客户端最后发送的消息的标示的表，如果收到的消息所带的标示小于等于表里所对应的标示，就忽略这条消息。

**消息压缩**
设计一个压缩算法或者使用第三方库


