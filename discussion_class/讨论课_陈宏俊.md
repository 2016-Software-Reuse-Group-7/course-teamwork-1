# 软件复用 - 讨论课01

## 讨论问题

用户登陆后始终在线，考虑低带宽/不稳定网络：

 - 长连接心跳机制
 - 消息不遗漏
 - 消息不重复
 - 消息压缩
 - ...

## 解决方案

### **1** 长连接

所谓长连接，就是要在客户端与服务器之间创建和保持稳定可靠的连接。要达到这种效果，需要客户端和服务器的程序共同配合来完成。通常的做法是，在服务器的程序中加入一个死循环，在循环中监测数据的变动。当发现新数据时，立即将其输出给浏览器并断开连接，浏览器在收到数据后，再次发起请求以进入下一个周期，这就是常说的长轮询（long-polling）方式。它通常包含以下几个关键过程：

- 轮询的建立
建立轮询的过程很简单，浏览器发起请求后进入循环等待状态，此时由于服务器还未做出应答，所以HTTP也一直处于连接状态中。
- 数据的推送
在循环过程中，服务器程序对数据变动进行监控，如发现更新，将该信息输出给浏览器，随即断开连接，完成应答过程，实现“服务器推”。 
- 轮询的终止
轮询可能在以下3种情况时终止： 
    - 有新数据推送
    当循环过程中服务器向浏览器推送信息后，应该主动结束程序运行从而让连接断开，这样浏览器才能及时收到数据。 
    - 没有新数据推送
    循环不能一直持续下去，应该设定一个最长时限，避免WEB服务器超时（Timeout），若一直没有新信息，服务器应主动向浏览器发送本次轮询无新信息的正常响应，并断开连接，这也被称为“心跳”信息。
    - 网络故障或异常
    由于网络故障等因素造成的请求超时或出错也可能导致轮询的意外中断，此时浏览器将收到错误信息。 
- 轮询的重建
浏览器收到回复并进行相应处理后，应马上重新发起请求，开始一个新的轮询周期。

### **2** 心跳机制

在浏览器与服务器之间维持一个长连接会为通信带来一些不确定性：因为数据传输是随机的，客户端不知道何时服务器才有数据传送。服务器端需要确保当客户端不再工作时，释放为这个客户端分配的资源，防止内存泄漏。因此需要一种机制使双方知道大家都在正常运行。实现方式：

- 服务器端在阻塞读时会设置一个时限，超时后阻塞读调用会返回，同时发给客户端没有新数据到达的心跳信息。此时如果客户端已经关闭，服务器往通道写数据会出现异常，服务器端就会及时释放为这个客户端分配的资源。
- 如果客户端使用的是基于 AJAX 的长轮询方式；服务器端返回数据、关闭连接后，经过某个时限没有收到客户端的再次请求，会认为客户端不能正常工作，会释放为这个客户端分配、维护的资源。
- 当服务器处理信息出现异常情况，需要发送错误信息通知客户端，同时释放资源、关闭连接。

### **3** 消息不遗漏

在实际应用时，从服务器做出应答，到下一次循环的建立，是有时间延迟的，延迟时间的长短受网络传输等多种因素影响，在这段时间内，长连接处于暂时断开的空档，如果恰好有数据在这段时间内发生变动，服务器是无法立即进行推送的。

服务器维护一个消息队列，向客户端发送消息，并确保客户端为每条消息都返回一个ack。

### **4** 消息不重复

当客户端返回的ack丢失时，服务器会发送重复的消息。

客户端维护一个MessageHashCodePool，每次接收到消息便将消息的HashCode加入池中，当池中已存在时则直接返回ACK，将消息忽略掉。

### **5** 消息的压缩

现在使用比较广泛的压缩技术Gzip。

并非所有的数据都经过压缩，所以客户端在接收到消息后，首先判断内容是否被压缩，然后再进行处理。
